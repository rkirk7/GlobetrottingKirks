<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blog Post</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <style>
    body { position: relative; }
    #toc {
      position: fixed; top: 80px; right: 20px;
      max-width: 250px; background: #fff;
      border: 1px solid #ddd; padding: 10px; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-height: 80vh; overflow-y: auto; z-index: 999;
      font-size: 0.95rem;
    }
    #toc h5 { font-size: 1rem; margin-bottom: 8px; }
    #toc ul { list-style: none; padding-left: 0; margin-bottom: 0; }
    #toc li { margin-bottom: 4px; }
    #toc a { text-decoration: none; font-size: 0.9rem; color: #333; }
    #toc a:hover { color: #007bff; text-decoration: underline; }

    /* Make blog-post-content full width */
    .blog-post-content {
      display: block;
      width: 100%;
    }
  </style>
</head>
<body class="bg-light">

  <div class="container mt-4 mb-5">
    <div id="post-container" class="card shadow-lg">
      <div class="card-body">
        <h1 id="post-title" class="mb-3"></h1>
        <div id="post-content" class="blog-post-content"></div>
        <div class="mt-3">
          <button id="shareBtn" class="btn btn-outline-primary">Share Post</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating TOC -->
  <div id="toc" class="d-none">
    <h5>On this page</h5>
    <ul id="toc-list"></ul>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    async function loadPost() {
      const params = new URLSearchParams(window.location.search);
      const postFile = params.get('post');
      if (!postFile) return;

      // Load Markdown
      let postText = await fetch(`blog-posts/${postFile}`).then(res => res.text());
      postText = postText.replace(/^---[\s\S]*?---/, '').trim();

      // Extract title
const lines = postText.split("\n");
const firstHeadingIndex = lines.findIndex(l => l.startsWith("# "));
const postTitle = firstHeadingIndex >= 0 ? lines[firstHeadingIndex].replace(/^# /, "") : postFile;
document.getElementById('post-title').textContent = postTitle;

// Remove the first H1 line so it doesn't show twice
if (firstHeadingIndex >= 0) {
  lines.splice(firstHeadingIndex, 1);
}
postText = lines.join("\n");

      // Parse markdown
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = marked.parse(postText);

      // Load image metadata
      const imageMeta = await fetch('image-data.json').then(res => res.json());

      // --- IMAGE & GALLERY HANDLING ---
     // --- IMAGE & GALLERY HANDLING ---
const images = Array.from(tempDiv.querySelectorAll('img'));
let galleryWrapper = null;

images.forEach((img, idx) => {
  const filename = img.getAttribute('src').split('/').pop();
  const caption = (imageMeta && imageMeta[filename]) || "";

  // Wrap img in figure if not already
  let figure = img.closest('figure');
  if (!figure) {
    figure = document.createElement('figure');
    img.parentNode.insertBefore(figure, img);
    figure.appendChild(img);
  }

  // Add figcaption
  let figcap = figure.querySelector('figcaption');
  if (!figcap && caption) {
    figcap = document.createElement('figcaption');
    figcap.textContent = caption;
    figure.appendChild(figcap);
  } else if (figcap) {
    figcap.textContent = caption;
  }

  // Wrap all images in one gallery div
  if (!galleryWrapper) {
    galleryWrapper = document.createElement('div');
    galleryWrapper.classList.add('gallery');
    figure.parentNode.insertBefore(galleryWrapper, figure);
  }
  galleryWrapper.appendChild(figure);

  // Add responsive class
  img.style.maxWidth = "100%";
  img.style.height = "auto";
  img.style.display = "block";
  img.style.margin = "0 auto";
});


      // --- TOC ---
      const tocList = document.getElementById('toc-list');
      const headings = tempDiv.querySelectorAll('h1, h2, h3');
      if (headings.length > 0) {
        document.getElementById('toc').classList.remove('d-none');
        headings.forEach((heading, i) => {
          const id = `heading-${i}`;
          heading.id = id;
          const li = document.createElement('li');
          li.innerHTML = `<a href="#${id}">${heading.textContent}</a>`;
          tocList.appendChild(li);
        });
      }

      // Insert final HTML
      document.getElementById('post-content').innerHTML = tempDiv.innerHTML;
    }

    // Share post
    function sharePost() {
      const url = window.location.href;
      if (navigator.share) {
        navigator.share({ title: document.title, url })
          .catch(err => console.log("Share canceled", err));
      } else {
        navigator.clipboard.writeText(url).then(() => {
          alert("Post URL copied to clipboard!");
        });
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadPost();
      document.getElementById("shareBtn").addEventListener("click", sharePost);
    });
  </script>
</body>
</html>
